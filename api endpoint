
// --- API ---
// Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ
app.post("/api/auth/register", async (req, res) => {
  const { username, password } = req.body;
  if (await User.findOne({ username })) {
    return res.status(400).json({ error: "ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚" });
  }
  const hashed = await bcrypt.hash(password, 10);
  const user = new User({ username, password: hashed });
  await user.save();
  res.json({ message: "Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ ÑƒÑÐ¿ÐµÑˆÐ½Ð°" });
});

// Ð›Ð¾Ð³Ð¸Ð½
app.post("/api/auth/login", async (req, res) => {
  const { username, password } = req.body;
  const user = await User.findOne({ username });
  if (!user) return res.status(400).json({ error: "ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ" });

  const valid = await bcrypt.compare(password, user.password);
  if (!valid) return res.status(400).json({ error: "ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ" });

  const token = jwt.sign({ id: user._id, username: user.username }, SECRET, { expiresIn: "1h" });
  res.json({ token });
});

// ÐŸÑ€Ð¾Ñ„Ð¸Ð»ÑŒ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ³Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
app.get("/api/users/me", auth, async (req, res) => {
  const user = await User.findById(req.user.id).select("-password");
  res.json(user);
});

// Ð¡Ð¿Ð¸ÑÐ¾Ðº Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹
app.get("/api/users", auth, async (req, res) => {
  const users = await User.find().select("-password");
  res.json(users);
});

// Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ Ñ‡Ð°Ñ‚
app.post("/api/chats", auth, async (req, res) => {
  const { name, participants } = req.body;
  const chat = new Chat({ name, participants: [req.user.id, ...participants] });
  await chat.save();
  res.json(chat);
});

// Ð¡Ð¿Ð¸ÑÐ¾Ðº Ñ‡Ð°Ñ‚Ð¾Ð² Ñ‚ÐµÐºÑƒÑ‰ÐµÐ³Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
app.get("/api/chats", auth, async (req, res) => {
  const chats = await Chat.find({ participants: req.user.id }).populate("participants", "username");
  res.json(chats);
});

// ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ñ‡Ð°Ñ‚ Ð¿Ð¾ id
app.get("/api/chats/:id", auth, async (req, res) => {
  const chat = await Chat.findById(req.params.id).populate("participants", "username");
  res.json(chat);
});

// ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ
app.post("/api/chats/:id/messages", auth, async (req, res) => {
  const message = new Message({
    chatId: req.params.id,
    senderId: req.user.id,
    text: req.body.text
  });
  await message.save();
  res.json(message);
});

// ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ñ‡Ð°Ñ‚Ð°
app.get("/api/chats/:id/messages", auth, async (req, res) => {
  const messages = await Message.find({ chatId: req.params.id })
    .populate("senderId", "username")
    .sort({ createdAt: 1 });
  res.json(messages);
});

// --- Start ---
app.listen(3000, () => console.log("ðŸš€ Ð¡ÐµÑ€Ð²ÐµÑ€ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð½Ð° http://localhost:3000"));